generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Attachment {
  fileUrl       String
  filename      String
  task_id       Int
  uploadedBy_id String @db.VarChar(13)
  attachment_id Int    @id @default(autoincrement())
  Task          Task   @relation(fields: [task_id], references: [task_id])
  Users         Users  @relation(fields: [uploadedBy_id], references: [users_id])
}

model Comment {
  comment_id Int      @id @default(autoincrement())
  text       String
  createdAt  DateTime @default(now())
  isRead     Boolean  @default(false)
  task_id    Int
  user_id    String   @db.VarChar(13)
  Task       Task     @relation(fields: [task_id], references: [task_id])
  Users      Users    @relation(fields: [user_id], references: [users_id])
}

model Grade {
  grade_id                        Int        @id @default(autoincrement())
  project_id                      Int
  term_id                         Int
  evaluator_id                    String     @db.VarChar(13)
  score                           GradeScore
  student_id                      String     @db.VarChar(13)
  Users_Grade_evaluator_idToUsers Users      @relation("Grade_evaluator_idToUsers", fields: [evaluator_id], references: [users_id])
  Project                         Project    @relation(fields: [project_id], references: [project_id])
  Users_Grade_student_idToUsers   Users      @relation("Grade_student_idToUsers", fields: [student_id], references: [users_id])
  Term                            Term       @relation(fields: [term_id], references: [term_id])
}

model Notification {
  notification_id                         Int      @id @default(autoincrement())
  user_id                                 String   @db.VarChar(13)
  actor_user_id                           String   @db.VarChar(13)
  title                                   String
  message                                 String
  link                                    String?
  isRead                                  Boolean  @default(false)
  createdAt                               DateTime @default(now())
  event_type                              String
  team_id                                 Int?
  task_id                                 Int?
  project_id                              Int?
  Users_Notification_actor_user_idToUsers Users    @relation("Notification_actor_user_idToUsers", fields: [actor_user_id], references: [users_id])
  Project                                 Project? @relation(fields: [project_id], references: [project_id])
  Task                                    Task?    @relation(fields: [task_id], references: [task_id])
  Team                                    Team?    @relation(fields: [team_id], references: [team_id])
  Users_Notification_user_idToUsers       Users    @relation("Notification_user_idToUsers", fields: [user_id], references: [users_id])
}

model Project {
  project_id     Int              @id @default(autoincrement())
  projectname    String           @db.VarChar(100)
  description    String?
  team_id        Int              @unique
  createdAt      DateTime         @default(now())
  project_type   String?
  projectnameEng String?          @db.VarChar(100)
  status         String?
  Grade          Grade[]
  Notification   Notification[]
  Team           Team             @relation(fields: [team_id], references: [team_id])
  ProjectAdvisor ProjectAdvisor[]
  Task           Task[]
}

model ProjectAdvisor {
  project_id        Int
  advisor_id        String  @db.VarChar(13)
  projectAdvisor_id Int     @id @default(autoincrement())
  Users             Users   @relation(fields: [advisor_id], references: [users_id])
  Project           Project @relation(fields: [project_id], references: [project_id])

  @@unique([project_id, advisor_id])
}

model Section {
  section_id         Int                  @id @default(autoincrement())
  section_code       String
  course_type        CourseType
  study_type         StudyType
  min_team_size      Int
  max_team_size      Int
  team_locked        Boolean              @default(false)
  term_id            Int
  Term               Term                 @relation(fields: [term_id], references: [term_id])
  Section_Enrollment Section_Enrollment[]
  Team               Team[]
  Event              Event[]

  @@unique([section_code, term_id])
}

model Section_Enrollment {
  section_enroll_id Int      @id @default(autoincrement())
  section_id        Int
  users_id          String   @db.VarChar(13)
  enrolledAt        DateTime @default(now())
  Section           Section  @relation(fields: [section_id], references: [section_id])
  Users             Users    @relation(fields: [users_id], references: [users_id])

  @@unique([section_id, users_id])
}

model Task {
  task_id        Int              @id @default(autoincrement())
  title          String           @db.VarChar(100)
  description    String?
  status         String           @db.VarChar(20)
  priority       String           @db.VarChar(20)
  tags           String?
  startDate      DateTime?
  dueDate        DateTime?
  authorUserId   String           @db.VarChar(13)
  project_id     Int
  position       Int              @default(0)
  Attachment     Attachment[]
  Comment        Comment[]
  Notification   Notification[]
  Users          Users            @relation(fields: [authorUserId], references: [users_id])
  Project        Project          @relation(fields: [project_id], references: [project_id])
  TaskAssignment TaskAssignment[]
}

model TaskAssignment {
  user_id           String @db.VarChar(13)
  task_id           Int
  taskAssignment_id Int    @id @default(autoincrement())
  Task              Task   @relation(fields: [task_id], references: [task_id])
  Users             Users  @relation(fields: [user_id], references: [users_id])

  @@unique([task_id, user_id])
}

model Team {
  team_id      Int            @id @default(autoincrement())
  section_id   Int
  advisorName  String?
  createdAt    DateTime       @default(now())
  description  String?
  groupNumber  String         @unique
  name         String
  semester     String
  status       String         @default("รออนุมัติหัวข้อ")
  topicThai    String?
  Notification Notification[]
  Project      Project?
  Section      Section        @relation(fields: [section_id], references: [section_id])
  Teammember   Teammember[]
  Users        Users[]
  Submission   Submission[]
}

model Teammember {
  team_id       Int
  user_id       String   @db.VarChar(13)
  joinedAt      DateTime @default(now())
  teammember_id Int      @id @default(autoincrement())
  Team          Team     @relation(fields: [team_id], references: [team_id])
  Users         Users    @relation(fields: [user_id], references: [users_id])

  @@unique([user_id, team_id])
}

model Term {
  term_id      Int       @id @default(autoincrement())
  academicYear Int
  semester     Int
  endDate      DateTime
  startDate    DateTime
  Grade        Grade[]
  Section      Section[]
}

model Users {
  users_id                                       String               @id @db.VarChar(13)
  passwordHash                                   String?              @db.VarChar(255)
  titles                                         String?              @db.VarChar(20)
  firstname                                      String?              @db.VarChar(50)
  lastname                                       String?              @db.VarChar(50)
  tel_number                                     String?              @db.VarChar(10)
  email                                          String?              @unique @db.VarChar(100)
  profilePicture                                 String?
  role                                           Role                 @default(STUDENT)
  teamId                                         Int?
  Attachment                                     Attachment[]
  Comment                                        Comment[]
  Grade_Grade_evaluator_idToUsers                Grade[]              @relation("Grade_evaluator_idToUsers")
  Grade_Grade_student_idToUsers                  Grade[]              @relation("Grade_student_idToUsers")
  Notification_Notification_actor_user_idToUsers Notification[]       @relation("Notification_actor_user_idToUsers")
  Notification_Notification_user_idToUsers       Notification[]       @relation("Notification_user_idToUsers")
  ProjectAdvisor                                 ProjectAdvisor[]
  Section_Enrollment                             Section_Enrollment[]
  Task                                           Task[]
  TaskAssignment                                 TaskAssignment[]
  Teammember                                     Teammember[]
  Team                                           Team?                @relation(fields: [teamId], references: [team_id])
  Submission_approvedBy                          Submission[]         @relation("Submission_approvedByToUsers")
}

enum CourseType {
  PRE_PROJECT
  PROJECT
}

enum GradeScore {
  A
  B_PLUS
  B
  C_PLUS
  C
  D_PLUS
  D
  F
}

enum Role {
  ADMIN
  ADVISOR
  STUDENT
}

enum StudyType {
  REG
  LE
}

// ===== Event System (กำหนดการ) =====

model Event {
  event_id    Int          @id @default(autoincrement())
  name        String       @db.VarChar(100)
  type        EventType
  description String?
  order       Int
  dueDate     DateTime
  section_id  Int
  createdAt   DateTime     @default(now())

  Section     Section      @relation(fields: [section_id], references: [section_id])
  Submission  Submission[]
}

model Submission {
  submission_id Int              @id @default(autoincrement())
  event_id      Int
  team_id       Int
  status        SubmissionStatus @default(PENDING)
  submittedAt   DateTime?
  file          String?
  feedback      String?
  approvedAt    DateTime?
  approvedBy    String?          @db.VarChar(13)
  createdAt     DateTime         @default(now())

  Event          Event   @relation(fields: [event_id], references: [event_id])
  Team           Team    @relation(fields: [team_id], references: [team_id])
  ApprovedByUser Users?  @relation("Submission_approvedByToUsers", fields: [approvedBy], references: [users_id])

  @@unique([event_id, team_id])
}

enum EventType {
  PROGRESS_REPORT
  DOCUMENT
  POSTER
  EXAM
  FINAL_SUBMISSION
  SEMINAR
  PRESENTATION
  MEETING
  PROPOSAL
}

enum SubmissionStatus {
  PENDING
  SUBMITTED
  NEEDS_REVISION
  APPROVED
}
